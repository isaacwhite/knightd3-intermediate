<html>
<head>
    <title>Motor Vehicle Collisions in NYC</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>

    <style type="text/css">
    .hidden {
        display: none !important;
    }

    .axis path,
    .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }

    .axis text {
        font-size: 8px;
    }

    .x.axis text {
        transform-origin: top right;
        transform: translate(-20px, 15px) rotate(-60deg);
        font-size: 9px;
    }

    .x.axis line,
    .x.axis path {
        display: none;
    }

    .chart-container {
        display: block;
        position: relative;
        width: 900px;
        margin: 30px auto 0;
        padding: 15px;
        background: white;
    }

    .tooltip-container {
        position: absolute;
        background-color: #d7d7d7;
        border-radius: 3px;
    }

    .tooltip-container .chart-wrap {
        position: relative;
    }

    .tooltip-arrow {
        position: absolute;
        bottom: -30px;
        border-top: 15px solid #d7d7d7;
        border-left: 15px solid transparent;
        border-bottom: 15px solid transparent;
        border-right: 15px solid transparent;
    }

    .tooltip-arrow.on-top {
        bottom: initial;
        top: -30px;
        border-top: 15px solid transparent;
        border-bottom: 15px solid #d7d7d7;
    }

    body {
        background: #d7d7d7;
        font-family: arial, helvetica, sans-serif;
    }

    </style>
</head>
<body>
    <div id="chart-container" class="chart-container">
        <p class="chart-description">The NYPD keeps a record of vehicle collections which are reported in NYC. Data includes time, precise location, borough, zip code, possible contributing factors to the incident, as well as categories of persons injured/killed. Data has been condensed for this graphic to only expose aggregate data on borough deaths/injuries by month. Original data from <a href="https://data.cityofnewyork.us/Public-Safety/NYPD-Motor-Vehicle-Collisions/h9gi-nx95">NYC Open Data</a>.</p>
        <div class="chart-wrap"></div>
        <div id="tooltip-container" class="tooltip-container hidden">
            <div class="chart-wrap">
                <div id="tooltip-arrow" class="tooltip-arrow"></div>
            </div>
        </div>
    </div>

</body>

<script type="text/javascript">
    (function () {
        'use strict';
        // grab a local reference to D3
        var d3 = window.d3;

        var mousePosition = {
            x: 0,
            y: 0
        };

        // d3 code needed to make chart svgs
        var createCanvas = function (target, options) {
            var $target = d3.select('#' + target);
            return {
                svg: $target
                    .select('.chart-wrap')
                    .append('svg')
                    .attr(options),
                parent: $target,
                settings: options
            };
        };

        var createColumnChart = function (chart, cbs) {
            var padding, width, height, xScale, yScale, xAxis, yAxis, barWidth;

            // we need to be passed a chart with an svg target to render on
            if (!chart || !chart.svg) {
                return;
            }

            // don't take these as options yet, maybe later.
            padding = {
                top: 20,
                right: 10,
                bottom: 60,
                left: 50
            };
            width = chart.settings.width - padding.right - padding.left;
            height = chart.settings.height - padding.top - padding.bottom;

            xScale = d3.scale
                .ordinal()
                .rangeRoundBands([0, width], 0.1);

            yScale = d3.scale
                .linear()
                .rangeRound([height, 0]);

            xAxis = d3.svg
                .axis()
                .scale(xScale)
                .orient('bottom');

            yAxis = d3.svg
                .axis()
                .scale(yScale)
                .orient('left')
                .ticks(16);

            d3.json('data_cleanup/output/nyc_motor_vehicle_collisions.json', function (data) {
                var groups, bars;

                // make an object where we'll save
                // modal positioning data later
                data = data.map(function (datum) {
                    datum.tooltip = {};
                    return datum;
                });

                // scales
                xScale.domain(data.map(function (datum) {
                    return datum.name;
                }));

                yScale.domain([0, d3.max(data, function (datum) {
                    return datum.all.total;
                })]);


                // axes
                chart.svg.append('g')
                    .attr('class', 'x axis')
                    .attr('transform', 'translate(' + padding.left + ',' + height + ')')
                    .call(xAxis);

                chart.svg.append('g')
                    .attr('class', 'y axis')
                    .attr('transform', 'translate(' + padding.left + ', 0)')
                    .call(yAxis);

                // columns
                groups = chart.svg
                    .append('g')
                    .attr('class', 'bars')
                    .selectAll('.bar')
                    .data(data)
                    .enter()
                    .append('g')
                    .attr('class', 'bar');

                barWidth = xScale.rangeBand();
                bars = groups.append('rect')
                    .attr({
                        x: function (datum) {
                            var leftEdge = padding.left + xScale(datum.name);
                            var maxLeft = 400;
                            if (leftEdge > maxLeft) {
                                datum.tooltip = {
                                    x: maxLeft,
                                    arrow: leftEdge + 9 - maxLeft
                                };
                            } else {
                                datum.tooltip = {
                                    x: leftEdge,
                                    arrow: 9
                                };
                            }

                            return leftEdge;
                        },
                        y: function (datum) {
                            return height;
                        },
                        width: barWidth,
                        height: 0,
                        fill: 'steelblue'
                    })
                    .on('mouseenter', function (datum) {
                        if (!cbs || !cbs.show) {
                            return;
                        }

                        cbs.show(datum);
                    }).on('mouseout', function (datum) {
                        if (!cbs || !cbs.hide) {
                            return;
                        }

                        cbs.hide(datum);
                    });

                // transition height initially
                bars.transition()
                    .delay(function(datum, index) {
                        return index * 50;
                    })
                    .duration(1000)
                    .attr({
                        height: function (datum) {
                            return height - yScale(datum.all.total);
                        },
                        y: function (datum) {
                            return yScale(datum.all.total);
                        }
                    });

            });

        };

        var createBarChart = function (chart, data) {
            return chart.svg.append('g');
        };

        // the svg elements we're going to use
        var charts = {
            main: createCanvas('chart-container', {
                width: 900,
                height: 500,
                id: 'main-chart'
            }),
            tooltip: createCanvas('tooltip-container', {
                width: 500,
                height: 300,
                id: 'chart-tooltip'
            }),
            tooltipHideDelay: 500 // .5s
        };

        var tooltipData = {};
        var queued = {
            cb: undefined,
            timeout: undefined
        };

        var showTooltip = function (datum) {
            var tooltipTop;
            var existing = tooltipData[datum.name];
            var $arrow = d3.select('#tooltip-arrow');

            if (mousePosition.y > 300) {
                // align below cursor
                tooltipTop = mousePosition.y - 360;
                $arrow.classed('on-top', false);
            } else {
                // align above cursor
                tooltipTop = mousePosition.y + 30;
                $arrow.classed('on-top', true);
            }

            // show the tooltip continaer
            charts.tooltip.parent.classed('hidden', false);

            if (queued.cb) {
                clearTimeout(queued.timeout);
                queued.cb();
                queued = {};
            }

            // we'll need to set this when we create the bars
            charts.tooltip.parent.style({
                top: tooltipTop + 'px',
                left: datum.tooltip.x + 'px'
            });

            $arrow.style({
                left: datum.tooltip.arrow + 'px'
            });

            // check for an already drawn chart
            if (existing) {
                // show it, don't need to draw a new one
                existing.classed('hidden', false);
                return;
            }

            tooltipData[datum.name] = createBarChart(charts.tooltip, datum.breakdown);
        };

        var hideTooltip = function (datum) {
            var hideParent = function () {
                // hide the container
                // charts.tooltip.parent.classed('hidden', true);
            };

            var partial = function (cb) {
                // hide the chart linked to this bar
                tooltipData[datum.name].classed('hidden', true);
                // indicate no longer queued
                queued = {};

                if (cb) {
                    // call callback
                    cb();
                }
            };

            var complete = function () {
                partial(hideParent);
            };

            queued = {
                timeout: setTimeout(complete, charts.tooltipHideDelay),
                cb: partial,
                datum: datum
            };
        };

        createColumnChart(charts.main, {
            show: showTooltip,
            hide: hideTooltip
        });

        charts.tooltip.parent.on('mouseenter', function () {
            clearTimeout(queued.timeout);
        });

        charts.tooltip.parent.on('mouseout', function () {
            var datum = queued.datum;
            queued = {};

            if (datum) {
                hideTooltip(datum);
            }
        });

        window.onmousemove = function (e) {
            mousePosition = e;
        };

    })();
</script>
</html>